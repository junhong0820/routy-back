<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.routy.routyback.mapper.user.MyRoutyMapper">
    <!-- ========================================================= -->
    <!-- MyRoutyMapper.xml                                         -->
    <!-- 내 제품(구매 인증된 제품) 목록을 조회하는 매퍼 XML 파일        -->
    <!-- userId → userNo 변환은 Service 층에서 처리됨                -->
    <!-- 이 XML은 오직 userNo 기반으로 구매 이력을 조회한다          -->
    <!-- ========================================================= -->

    <select id="selectMyProducts" resultType="com.routy.routyback.dto.user.myrouty.MyProductResponse">
        SELECT p.PRDNO                                 AS prdNo,        -- 상품 번호 (중복 기준)
               MAX(p.PRDNAME)                          AS prdName,      -- 상품 이름
               MAX(p.PRDIMG)                           AS prdImg,       -- 상품 이미지
               MAX(p.PRDMAINcate)                      AS mainCategory, -- 메인 카테고리
               SUM(ppm.PPMAPSTOCK)                     AS qty,          -- 총 구매 수량
               MAX(ppm.PPMAPPRICE)                     AS buyPrice,     -- 최근 구매 가격
               MAX(TO_CHAR(o.ODREGDATE, 'YYYY-MM-DD')) AS buyDate       -- 최근 구매일
        FROM PAY_PRODUCT_MAPPING ppm
                 JOIN ORDERS o
                      ON ppm.ODNO = o.ODNO
                 JOIN PRODUCT p
                      ON ppm.PRDNO = p.PRDNO
        WHERE o.USERNO = #{userNo}
          AND o.ODSTATUS = 1
        GROUP BY p.PRDNO
        ORDER BY MAX(o.ODREGDATE) DESC
    </select>

</mapper>