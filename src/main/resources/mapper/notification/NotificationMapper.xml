<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--
  알림 관련 쿼리를 모아둔 Mapper XML
  namespace는 Mapper 인터페이스의 FQCN과 동일해야 함
-->
<mapper namespace="com.routy.routyback.mapper.notification.NotificationMapper">

    <!--
      1) 읽지 않은 알림 개수 조회
         - USER_NOTIFICATION 에서 IS_READ = 'N' 인 건만 카운트
    -->
    <select id="getUnreadCount" resultType="int">
        SELECT COUNT(*)
        FROM USER_NOTIFICATION
        WHERE USER_NO = #{userNo}
          AND IS_READ = 'N'
    </select>

    <!--
      2) 알림 목록 조회
         - 최신 생성일(CREATED_AT) 기준 내림차순 정렬
         - 컬럼명 → DTO 필드명으로 alias 매핑
    -->
    <select id="getNotificationList"
        resultType="com.routy.routyback.dto.notification.NotificationResponse">
        SELECT NOTI_ID                                      AS notiId,
               NOTI_TITLE                                   AS title,
               NOTI_MESSAGE                                 AS message,
               NOTI_TYPE                                    AS type,
               IS_READ                                      AS unread,
               TO_CHAR(CREATED_AT, 'YYYY-MM-DD HH24:MI:SS') AS createdAt
        FROM USER_NOTIFICATION
        WHERE USER_NO = #{userNo}
        ORDER BY CREATED_AT DESC
    </select>

    <!--
      3) 전체 읽음 처리
         - READ_AT, UPDATED_AT 도 함께 갱신
         - 이미 읽은 건(IS_READ='Y')는 건너뜀
    -->
    <update id="readAll">
        UPDATE USER_NOTIFICATION
        SET IS_READ    = 'Y',
            READ_AT    = SYSTIMESTAMP,
            UPDATED_AT = SYSTIMESTAMP
        WHERE USER_NO = #{userNo}
          AND IS_READ = 'N'
    </update>

    <!--
    4) 개별 알림 읽음 처리
     - NOTI_ID 기준으로 특정 알림만 읽음 처리
    -->
    <update id="readOne">
        UPDATE USER_NOTIFICATION
        SET IS_READ    = 'Y',
            READ_AT    = SYSTIMESTAMP,
            UPDATED_AT = SYSTIMESTAMP
        WHERE NOTI_ID = #{notiId}
    </update>

    <!--
    5) 개별 알림 삭제
     - NOTI_ID 기준으로 특정 알림 삭제
    -->
    <delete id="deleteOne">
        DELETE
        FROM USER_NOTIFICATION
        WHERE NOTI_ID = #{notiId}
    </delete>

    <!--
      6) 전체 알림 삭제
         - USER_NO 기준으로 모든 알림 삭제
    -->
    <delete id="deleteAll">
        DELETE
        FROM USER_NOTIFICATION
        WHERE USER_NO = #{userNo}
    </delete>


</mapper>